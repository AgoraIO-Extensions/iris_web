import fs from 'fs';
import path from 'path';

import { CXXFile, CXXTYPE, CXXTerraNode } from '@agoraio-extensions/cxx-parser';
import {
  ParseResult,
  RenderResult,
  TerraContext,
} from '@agoraio-extensions/terra-core';

export default function (
  terraContext: TerraContext,
  args: any,
  parseResult: ParseResult
): RenderResult[] {
  let cxxfiles = parseResult.nodes as CXXFile[];
  let view = cxxfiles.map((cxxfile: CXXFile) => {
    let nodes = cxxfile.nodes.filter((node: CXXTerraNode) => {
      return node.__TYPE === CXXTYPE.Clazz;
    });

    //移除没有名字的node
    cxxfile.nodes = cxxfile.nodes.filter((node) => {
      return node.name !== '';
    });

    return cxxfile;
  });
  //remove Clazz/Enumz/Struct doesn't exist file
  view = view.filter((cxxfile) => {
    return (
      cxxfile.nodes.filter((node) => {
        return (
          node.__TYPE === CXXTYPE.Clazz
        );
      }).length > 0
    );
  });
  let renderList:string[] = ['/// Generated by terra, DO NOT MODIFY BY HAND.'];
  view.map((cxxfile) => {
    cxxfile.nodes.map((node) => {
      node.asClazz().methods.map((method) => {
        if(!renderList.includes(`export const ${method.user_data.IrisApiIdParser.key}="${method.user_data.IrisApiIdParser.value}";`)){
          renderList.push(`export const ${method.user_data.IrisApiIdParser.key}="${method.user_data.IrisApiIdParser.value}";`);
        }
      });
    });
  });
  return [{
    file_name: path.join('src/util', 'iris_rtc_api_type_gen.ts'),
    file_content: renderList.join('\n'),
  }];
}
